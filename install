#!/usr/bin/env bash

set -e

# Check if host argument is provided
if [ $# -eq 0 ]; then
    echo "Error: Host argument is required."
    echo "Usage: $0 <host>"
    echo "Example: $0 framework"
    exit 1
fi

host="$1"

NIXOS_DIR="${HOME}/dotfiles/nixos"

# Check if nixos directory exists
if [ ! -d "$NIXOS_DIR" ]; then
    echo "Error: NixOS directory '$NIXOS_DIR' does not exist."
    exit 1
fi

# Check if host directory exists
HOST_DIR="${NIXOS_DIR}/hosts/${host}"
if [ ! -d "$HOST_DIR" ]; then
    echo "Error: Host directory '$HOST_DIR' does not exist."
    exit 1
fi

echo "Using host: $host"
echo "Rebuilding NixOS configuration..."

cd "${NIXOS_DIR}"

sudo nixos-rebuild switch --flake ".#${host}" "${@:2}"

